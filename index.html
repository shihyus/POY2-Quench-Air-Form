<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POY2 Quench Air Reading</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700&display=swap');

  :root {
    --bg: #f0f4f9;
    --surface: #ffffff;
    --border: #c5d3e8;
    --accent: #1a4b8c;
    --accent-dim: rgba(26,75,140,0.08);
    --text: #1a2a40;
    --text-muted: #5a7a9a;
    --error: #c0392b;
    --success: #1a6b3c;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    padding: 24px 16px 48px;
    max-width: 900px;
    margin: 0 auto;
  }

  header {
    background: var(--accent);
    border-radius: 8px;
    padding: 20px 24px;
    margin-bottom: 24px;
  }

  header h1 {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 26px;
    font-weight: 700;
    letter-spacing: 0.04em;
    color: #ffffff;
  }

  .date-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .date-section label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    white-space: nowrap;
  }

  .date-section input {
    background: #f7faff;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 15px;
    padding: 8px 12px;
    transition: border-color 0.15s;
    -webkit-appearance: none;
  }

  .date-section input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .line-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 12px;
    position: relative;
  }

  .line-block-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
  }

  .line-block-header .section-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 10px;
    letter-spacing: 0.15em;
    color: var(--text-muted);
    text-transform: uppercase;
  }

  .remove-btn {
    background: none;
    border: 1px solid #3a2d3e;
    border-radius: 4px;
    color: var(--error);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px;
    padding: 4px 10px;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.15s;
  }

  .remove-btn:hover { opacity: 1; }

  .line-select {
    background: #f7faff;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 15px;
    padding: 9px 32px 9px 12px;
    width: 100%;
    margin-bottom: 14px;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7080' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    transition: border-color 0.15s;
  }

  .line-select:focus {
    outline: none;
    border-color: var(--accent);
  }

  .positions-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }

  .pos-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .pos-field label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
  }

  .pos-field input {
    background: #f7faff;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    padding: 8px 6px;
    width: 100%;
    text-align: center;
    transition: border-color 0.15s, background 0.15s;
    -webkit-appearance: none;
  }

  .pos-field input:focus {
    outline: none;
    border-color: var(--accent);
    background: var(--accent-dim);
  }

  .pos-field input.has-value {
    border-color: rgba(0,212,170,0.4);
  }

  .pos-field input.invalid {
    border-color: var(--error) !important;
    background: rgba(255,107,107,0.08) !important;
    color: var(--error);
  }



  .add-btn {
    width: 100%;
    padding: 14px;
    background: transparent;
    border: 1px dashed var(--border);
    border-radius: 8px;
    color: var(--text-muted);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 13px;
    letter-spacing: 0.08em;
    cursor: pointer;
    margin-bottom: 16px;
    transition: border-color 0.15s, color 0.15s;
  }

  .add-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .submit-btn {
    width: 100%;
    padding: 16px;
    background: var(--accent);
    border: none;
    border-radius: 6px;
    color: #ffffff;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: opacity 0.15s, transform 0.1s;
  }

  .submit-btn:active { transform: scale(0.98); opacity: 0.9; }
  .submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  #status {
    margin-top: 12px;
    padding: 12px 16px;
    border-radius: 6px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    text-align: center;
    display: none;
  }

  #status.success {
    background: rgba(0,212,170,0.1);
    border: 1px solid rgba(0,212,170,0.3);
    color: var(--success);
    display: block;
  }

  #status.error {
    background: rgba(255,107,107,0.1);
    border: 1px solid rgba(255,107,107,0.3);
    color: var(--error);
    display: block;
  }
</style>
</head>
<body>

<header>
  <h1>POY2 Quench Air Reading</h1>
</header>

<div class="date-section">
  <label>DATE</label>
  <input type="date" id="globalDate" required>
</div>

<div id="lineBlocks"></div>

<button class="add-btn" onclick="addBlock()">+ Add Line</button>
<button class="submit-btn" id="submitBtn" onclick="submitAll()">Submit All</button>
<div id="status"></div>

<script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyAW6f3SQML4sHBK5tm7RUwpxV2SuQ1trsR_mi69C4BOHOHnk4cQX1lSe1XnunpXCRESw/exec';
  const LINES = ['3A','3B','3C','3D','3E','3F','3G','3H','3I','3J','3K','3L','3M','3N','3O','3P','3Q','3R'];

  document.getElementById('globalDate').value = new Date().toISOString().split('T')[0];

  let blockCount = 0;

  function validatePos(input) {
    const val = parseFloat(input.value);
    if (input.value === '') {
      input.classList.remove('has-value', 'invalid');
    } else if (val > 2 && val < 30) {
      input.classList.add('has-value');
      input.classList.remove('invalid');
    } else {
      input.classList.add('invalid');
      input.classList.remove('has-value');
    }
  }

  function addBlock() {
    blockCount++;
    const id = blockCount;
    const div = document.createElement('div');
    div.className = 'line-block';
    div.id = 'block-' + id;

    const lineOptions = LINES.map(l => `<option value="${l}">${l}</option>`).join('');

    let posFields = '';
    for (let i = 1; i <= 16; i++) {
      const num = String(i).padStart(2, '0');
      posFields += `<div class="pos-field">
        <label>POS ${i}</label>
        <input type="number" id="b${id}_p${num}" inputmode="decimal" step="any" placeholder="—"
          oninput="validatePos(this)">
      </div>`;
    }

    div.innerHTML = `
      <div class="line-block-header">
        <span class="section-label">Line ${id}</span>
        <button class="remove-btn" onclick="removeBlock(${id})">Remove</button>
      </div>
      <select class="line-select" id="b${id}_line">
        <option value="">Select Line</option>
        ${lineOptions}
      </select>
      <div class="positions-grid">${posFields}</div>
    `;

    document.getElementById('lineBlocks').appendChild(div);
  }

  function removeBlock(id) {
    const el = document.getElementById('block-' + id);
    if (el) el.remove();
  }

  async function submitAll() {
    const date = document.getElementById('globalDate').value;
    if (!date) { alert('Please select a date.'); return; }

    const blocks = document.querySelectorAll('.line-block');
    if (blocks.length === 0) { alert('Please add at least one line.'); return; }

    // Validate all blocks have a line selected
    for (const block of blocks) {
      const id = block.id.replace('block-', '');
      const line = document.getElementById('b' + id + '_line').value;
      if (!line) { alert('Please select a line for all blocks.'); return; }
    }

    // Check for out-of-range values
    const invalidInputs = document.querySelectorAll('.pos-field input.invalid');
    if (invalidInputs.length > 0) {
      alert('Some values are out of range (must be between 2 and 30). Please correct them before submitting.');
      invalidInputs[0].focus();
      return;
    }

    const btn = document.getElementById('submitBtn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = 'Sending...';
    status.className = '';
    status.style.display = 'none';

    let successCount = 0;
    let failCount = 0;

    for (const block of blocks) {
      const id = block.id.replace('block-', '');
      const payload = {
        date: date,
        line: document.getElementById('b' + id + '_line').value,
      };
      for (let i = 1; i <= 16; i++) {
        const num = String(i).padStart(2, '0');
        const val = document.getElementById('b' + id + '_p' + num).value;
        payload['p' + num] = val !== '' ? parseFloat(val) : '';
      }

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        successCount++;
      } catch (err) {
        failCount++;
      }
    }

    if (failCount === 0) {
      status.textContent = `✓ ${successCount} line(s) successfully submitted.`;
      status.className = 'success';
      document.getElementById('lineBlocks').innerHTML = '';
      blockCount = 0;
      addBlock();
    } else {
      status.textContent = `✗ ${failCount} line(s) failed to send. Please retry.`;
      status.className = 'error';
    }

    btn.disabled = false;
    btn.textContent = 'Submit All';
  }

  // Start with one block
  addBlock();
</script>
</body>
</html>
